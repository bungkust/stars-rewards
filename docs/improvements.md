# Codebase Audit: Loopholes & Improvements

This document outlines potential security loopholes, architectural limitations, and areas for improvement identified during a code audit of the `stars-rewards` project.

## üö® Security Loopholes (The "Smart Kid" Threat Model)

Since the application currently relies entirely on **LocalStorage** and client-side logic, a tech-savvy child could exploit several vulnerabilities to bypass restrictions or manipulate rewards.

### 1. Plain Text Data Manipulation
-   **Vulnerability**: All data (including `current_balance`, `adminPin`, and task history) is stored in `localStorage` under the key `stars-rewards-db` as a plain JSON string.
-   **Exploit**: A user can open the browser's Developer Tools (Application tab), edit the `current_balance` value to `999999`, or remove the `adminPin` to reset access.
-   **Fix**:
    -   **Short-term**: Encrypt the `localStorage` data using a library like `crypto-js` to make casual editing difficult.
    -   **Long-term**: Move critical logic (balance updates, verification) to a server-side backend (Supabase) with Row Level Security (RLS).

### 2. Backup & Restore Exploit
-   **Vulnerability**: The `importData` function in `useAppStore.ts` and `localStorageService.ts` accepts a JSON object and overwrites the current state with minimal validation.
-   **Exploit**: A user can export a backup, modify the JSON file (e.g., increase balance, mark tasks as verified), and import it back to apply the changes.
-   **Fix**: Add a checksum or digital signature to the backup file generated by the app. Verify this signature upon import to ensure the file hasn't been tampered with.

### 3. Client-Side Admin Verification
-   **Vulnerability**: The `verifyPin` function checks the PIN against the value stored in the client-side state.
-   **Exploit**: A user could potentially manipulate the running application state (e.g., using React DevTools) to set `isAdminMode` to `true` without knowing the PIN.
-   **Fix**: Move sensitive admin actions to require a server-side verification token, or at least re-prompt for PIN before critical destructive actions.

### 4. Time Travel
-   **Vulnerability**: The `checkMissedMissions` and task availability logic rely on the device's system time.
-   **Exploit**: A user could change their device date to the future to unlock tasks early, or to the past to complete missed missions.
-   **Fix**: Use a trusted time source (NTP or server time) if online. If offline, detecting time manipulation is difficult but one could track "last seen" timestamps and flag inconsistencies.

---

## üèó Architecture & Scalability

### 1. Hardcoded User ID (`local-user`)
-   **Issue**: The codebase uses a hardcoded string `'local-user'` in `useAppStore.ts`, `dataService.ts`, and `localStorageService.ts`.
-   **Impact**: The application currently supports only a single "family" or user context. It cannot be easily extended to support multiple users or cloud sync without significant refactoring.
-   **Improvement**: Replace `'local-user'` with a dynamic `userId` retrieved from an auth provider (like Supabase Auth). Update service methods to accept `userId` as a parameter.

### 2. Optimistic Updates without Rollback
-   **Issue**: `useAppStore.ts` updates the UI state *before* the data service confirms the operation (Optimistic UI).
-   **Impact**: If the `dataService` fails (e.g., storage quota exceeded), the UI will show a success state while the data remains unchanged, leading to a sync issue.
-   **Improvement**: Implement a rollback mechanism. If the async action fails, revert the state change and show an error toast.

### 3. Destructive Deletes
-   **Issue**: `deleteChild` and `deleteReward` permanently remove data.
-   **Impact**: Accidental deletion leads to unrecoverable data loss.
-   **Improvement**: Implement "Soft Delete" (e.g., `deleted_at` column/field). This allows for data recovery and better historical reporting.

---

## üßπ Code Quality & Logic

### 1. Complex Logic in Store (`checkMissedMissions`)
-   **Issue**: The `checkMissedMissions` function in `useAppStore.ts` is extremely long (~200 lines) and contains complex date iteration logic.
-   **Impact**: This makes the store file hard to read and maintain. It also violates the Single Responsibility Principle.
-   **Improvement**: Extract this logic into a dedicated service (e.g., `MissionLogicService.ts` or `src/logic/missedMissions.ts`) that returns the logs to be added. The store should only handle state updates.

### 2. Performance of Missed Mission Check
-   **Issue**: The current logic iterates through every day between `lastMissedCheckDate` and today, for every active task and every child.
-   **Impact**: If a user hasn't opened the app in a long time, this could cause a noticeable freeze on startup.
-   **Improvement**: Optimize the loop. For example, batch database writes instead of calling `dataService.logFailedTask` inside the inner loop.

### 3. Type Safety
-   **Issue**: Some methods return `{ error: any }` or use `any` in `restoreBackup`.
-   **Impact**: Reduces type safety and makes error handling less predictable.
-   **Improvement**: Define a proper `AppError` type and use it consistently. Validate imported data using a schema validator (like `zod`) in `restoreBackup`.

### 4. Duplicate Logic
-   **Issue**: Streak calculation logic appears in `approveExemption` and `verifyTask` inside the store.
-   **Improvement**: Centralize streak calculation logic in a helper function or within the `Task` model/service.
